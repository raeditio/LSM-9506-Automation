Dim WithEvents serialPort As MSCommLib.MSComm
Dim outputDetected As Boolean
Dim skipDetected As Boolean
Dim receivedData As String

Sub StartDataCaptureAndLogData()
    Dim comPort As String
    comPort = InputBox("Enter the COM port (e.g., COM1):", "COM Port Selection")

    If comPort = "" Then
        MsgBox "COM port not specified. Exiting."
        Exit Sub
    End If
    
    ' Initialize MSComm control
    Set serialPort = New MSCommLib.MSComm
    With serialPort
        .CommPort = Val(Mid(comPort, 4)) ' Extract the port number (e.g., from "COM1" to "1")
        .Settings = "9600,N,8,1" ' Set your desired settings
        .InputMode = comInputModeText
        .PortOpen = True
    End With
    
    outputDetected = False
    skipDetected = False
    receivedData = ""
    
    MsgBox "Start signal sent. Waiting for data..."
    
    Do
        Application.Wait Now + TimeValue("0:00:02") ' Wait for 2 seconds
        
        If serialPort.InBufferCount > 0 Then
            receivedData = serialPort.Input
            If Len(receivedData) > 3 Then
                receivedData = Mid(receivedData, 4) ' Remove first three characters
            Else
                receivedData = "" ' If less than 3 characters, set as empty string
            End If
            
            ' Log the modified received data into Column C starting from the selected row
            Dim selectedRow As Long
            selectedRow = ActiveCell.Row
            
            Cells(selectedRow, 3).Value = receivedData
            selectedRow = selectedRow + 1 ' Move to the next row
        Else
            MsgBox "No data received."
        End If
        
    Loop
End Sub

Private Sub Workbook_BeforeClose(Cancel As Boolean)
    If serialPort.PortOpen Then
        serialPort.PortOpen = False
    End If
End Sub
