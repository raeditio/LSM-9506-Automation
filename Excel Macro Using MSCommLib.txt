Sub ReadWriteSerialData_OpenStatement()
    Dim comPort As String
    comPort = InputBox("Enter COM Port (e.g., COM21):", "COM Port Selection", "COM21")
    
    If comPort = "" Then
        comPort = "COM21" ' Default COM port if skipped
    End If
    
    Dim fileNumber As Integer
    fileNumber = FreeFile
    
    Open comPort For Binary Access Read Write As #fileNumber
    
    If Err Then
        MsgBox "Error opening COM port. Check port settings."
        Exit Sub
    End If
    
    ' Write 'R' command to the device
    Print #fileNumber, "R"
    
    Dim receivedData As String
    Do Until EOF(fileNumber)
        Input #fileNumber, receivedData ' Read data from the COM port
        
        ' Process the received data based on requirements
        Select Case True
            Case Left(receivedData, 3) = "ER0"
                Do
                    Print #fileNumber, "D" ' Send 'D' command until non-ER0 data received
                    DoEvents
                    Input #fileNumber, receivedData ' Read data from the COM port
                    If Left(receivedData, 3) <> "ER0" Then
                        ActiveCell.Value = receivedData ' Record non-ER0 data to selected cell
                        Exit Do
                    End If
                Loop Until False
            
            Case Left(receivedData, 2) = "ER"
                MsgBox "Error: " & receivedData & ". Terminating macro."
                Close #fileNumber
                Exit Sub
            
            Case receivedData = ""
                MsgBox "No data received. Terminating macro."
                Close #fileNumber
                Exit Sub
            
            Case Else
                ActiveCell.Value = receivedData ' Record data to selected cell
        End Select
        
        ' Write 'D' command once every second
        Print #fileNumber, "D"
        Application.Wait Now + TimeValue("00:00:01") ' Wait for one second
    Loop
    
    Close #fileNumber ' Close the COM port
End Sub

