Sub ReadWriteSerialData_OpenStatement()
    Dim comPort As String
    comPort = InputBox("Enter COM Port (e.g., COM1):", "COM Port Selection", "COM1")
    
    If comPort = "" Then
        comPort = "COM1" ' Default COM port if skipped
    End If
    
    Dim fileNumber As Integer
    fileNumber = FreeFile
    
    Open comPort For Random As #fileNumber Len = 1 ' Open the COM port
    
    If Err Then
        MsgBox "Error opening COM port. Check port settings."
        Exit Sub
    End If
    
    ' Write 'R' command to the device
    Put #fileNumber, , "R"
    
    Dim receivedData As String
    Do
        Get #fileNumber, , receivedData ' Read data from the COM port
        
        ' Process the received data based on requirements
        Select Case True
            Case Left(receivedData, 3) = "ER0"
                Do
                    Put #fileNumber, , "D" ' Send 'D' command until non-ER0 data received
                    DoEvents
                    Get #fileNumber, , receivedData ' Read data from the COM port
                    If Left(receivedData, 3) <> "ER0" Then
                        ActiveCell.Value = receivedData ' Record non-ER0 data to selected cell
                        Exit Do
                    End If
                Loop Until False
            
            Case Left(receivedData, 2) = "ER"
                MsgBox "Error: " & receivedData & ". Terminating macro."
                Close #fileNumber
                Exit Sub
            
            Case receivedData = ""
                MsgBox "No data received. Terminating macro."
                Close #fileNumber
                Exit Sub
            
            Case Else
                ActiveCell.Value = receivedData ' Record data to selected cell
        End Select
        
        ' Write 'D' command once every second
        Put #fileNumber, , "D"
        Application.Wait Now + TimeValue("00:00:01") ' Wait for one second
    Loop Until False
    
    Close #fileNumber ' Close the COM port
End Sub
