Sub ReadDataFromCOM21()
    Dim comPort As String
    comPort = "COM21" ' Replace with your COM port
    
    ' Send data measurement start signal
    Dim startSignal As String
    startSignal = "R" ' Replace with your start signal
    SendSerialData comPort, startSignal
    
    ' Log the first data into the selected cell
    Dim firstData As String
    firstData = ReadSerialData(comPort)
    ActiveCell.Value = firstData
    
    ' Start continuous data request loop
    Do
        Application.Wait Now + TimeSerial(0, 0, 1) ' Wait for 1 second
        
        ' Request data every second
        Dim requestData As String
        requestData = ReadSerialData(comPort)
        
        ' Check if error code is detected in the received data
        If Left(requestData, 5) = "ER0" Then
            ' Log the next data entry to the next row
            ActiveCell.Offset(1, 0).Value = Mid(requestData, 7) ' Log data without the error code
        End If
    Loop
End Sub

Function ReadSerialData(comPort As String) As String
    On Error Resume Next ' Suppress error for timeout or no data received
    
    Dim receivedData As String
    Dim objShell As Object
    Dim objExec As Object
    
    Set objShell = CreateObject("WScript.Shell")
    Set objExec = objShell.Exec("powershell.exe -Command ""& { $port= new-Object System.IO.Ports.SerialPort '" & comPort & "', 9600; $port.Open(); $receivedData = $port.ReadLine(); $port.Close(); $receivedData }""")
    
    receivedData = objExec.StdOut.ReadAll()
    ReadSerialData = Trim(receivedData)
End Function

Sub SendSerialData(comPort As String, data As String)
    Dim objShell As Object
    Set objShell = CreateObject("WScript.Shell")
    
    objShell.Run "powershell.exe -Command ""& { $port= new-Object System.IO.Ports.SerialPort '" & comPort & "', 9600; $port.Open(); $port.WriteLine('" & data & "'); $port.Close(); }"""
End Sub
