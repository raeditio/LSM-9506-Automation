Sub StartDataCaptureAndLogData()
    Dim outputDetected As Boolean
    Dim skipDetected As Boolean
    Dim receivedData As String
    Dim comPort As String
    Dim firstDataLogged As Boolean
    
    ' Prompt the user to input the COM port
    comPort = InputBox("Enter the COM port (e.g., COM1):", "COM Port Selection")
    
    ' Validate the COM port input
    If comPort = "" Then
        MsgBox "COM port not specified. Exiting."
        Exit Sub
    End If
    
    ' Send a signal to start data capture
    Dim objShell As Object
    Dim objExec As Object
    Set objShell = CreateObject("WScript.Shell")
    Set objExec = objShell.Exec("powershell.exe -Command ""& { $port= new-Object System.IO.Ports.SerialPort '" & comPort & "', 9600; $port.Open(); $port.WriteLine('CR'); $port.Close(); }""")
    
    MsgBox "Start signal sent. Waiting for data..."
    
    outputDetected = False
    skipDetected = False
    receivedData = ""
    
    firstDataLogged = False
    outputDetected = False
    skipDetected = False
    receivedData = ""
    
    Do
        Application.Wait Now + TimeValue("0:00:02") ' Wait for 2 seconds
        
        ' Read data from the serial port using PowerShell with the user-specified COM port
        Set objShell = CreateObject("WScript.Shell")
        Set objExec = objShell.Exec("powershell.exe -Command ""& { $port= new-Object System.IO.Ports.SerialPort '" & comPort & "', 9600; $port.Open(); Start-Sleep -s 1; $receivedData = $port.ReadLine(); $port.Close(); $receivedData }""")
        
        receivedData = objExec.StdOut.ReadAll()
        
        If Len(receivedData) > 0 Then
            ' Remove the first three characters from the received data
            If Len(receivedData) > 3 Then
                receivedData = Mid(receivedData, 4) ' Remove first three characters
            Else
                receivedData = "" ' If less than 3 characters, set as empty string
            End If
            
            ' Log the received data into Column C starting from the selected row
            Dim selectedRow As Long
            selectedRow = ActiveCell.Row
            
            If Not firstDataLogged Then
                Cells(selectedRow, 3).Value = receivedData
                firstDataLogged = True
            Else
                If Not outputDetected Then
                    Cells(selectedRow + 1, 3).Value = receivedData
                    selectedRow = selectedRow + 1 ' Move to the next row
                End If
            End If
            outputDetected = True
        Else
            outputDetected = False
        End If
    Loop
    ' Send stop command to the device after data logging is completed
    Dim stopCommand As String
    stopCommand = "CL" ' Stop command is CL
    Set objShell = CreateObject("WScript.Shell")
    objShell.Run "powershell.exe -Command ""& { $port= new-Object System.IO.Ports.SerialPort '" & comPort & "', 9600; $port.Open(); $port.WriteLine('" & stopCommand & "'); $port.Close(); }"""
End Sub
